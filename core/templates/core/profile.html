{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="min-h-screen flex flex-col items-center px-4 py-8" style="background: none;">
    <!-- Profile Icon (Top Left, Thin White Ring) -->
    {% include 'core/app_icon.html' %}
    <!-- Friends Section (3rd Icon) Redesigned - moved to top for visibility -->
    <div class="w-full flex flex-col items-center mt-4" style="align-items: flex-start;">
        <!-- Card 1: Invite Code Input -->
        <div class="w-full max-w-sm bg-black/30 backdrop-blur-2xl border border-white/10 rounded-3xl shadow-2xl p-4 flex flex-row items-center gap-2 animate-fade-in mb-4" style="margin-top: 0;">
            <form id="invite-form" class="flex flex-row w-full items-center gap-2">
                {% csrf_token %}
                <input name="invite_code" type="text" maxlength="5" placeholder="Enter invite code" class="flex-1 px-4 py-2 rounded-xl bg-black/40 border border-white/10 text-white text-center placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-400/40 transition-all duration-200" autocomplete="off" required />
                <button type="submit" class="ml-2 px-5 py-2 rounded-xl bg-gradient-to-r from-black/60 to-white/10 text-white font-semibold shadow hover:bg-white/10 border border-white/10 transition-all duration-200 whitespace-nowrap">Join</button>
            </form>
        </div>
        <!-- Card 2: Paired Users List -->
        <div class="w-full max-w-sm bg-black/30 backdrop-blur-2xl border border-white/10 rounded-3xl shadow-2xl p-4 animate-fade-in" style="max-height: 270px; overflow-y: auto;">
            {% if paired_users %}
                <ul class="w-full flex flex-col gap-3">
                    {% for friend in paired_users %}
                        <li class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 flex items-center justify-between shadow-sm">
                            <span class="font-medium text-white/90 text-base">
                                {{ friend.get_full_name|default:friend.email|default:"Unknown" }}
                            </span>
                            <span class="text-xs px-2 py-1 rounded bg-white/10 text-gray-300/80 font-semibold tracking-wide">
                                {% if friend.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="w-full bg-black/30 border border-white/10 rounded-2xl px-6 py-8 flex flex-col items-center justify-center shadow-inner mt-2">
                    <svg width="40" height="40" fill="none" viewBox="0 0 24 24" class="mb-2 opacity-60">
                        <circle cx="12" cy="12" r="10" stroke="white" stroke-width="1.5" fill="rgba(255,255,255,0.04)"/>
                        <path d="M8 15c0-1.657 2.686-3 6-3s6 1.343 6 3" stroke="white" stroke-width="1.2" stroke-linecap="round"/>
                        <circle cx="12" cy="9" r="3" stroke="white" stroke-width="1.2"/>
                    </svg>
                    <span class="text-gray-400/80 text-base font-medium">No members paired</span>
                </div>
            {% endif %}
        </div>
    </div>
<style>
body, html {
  overflow: hidden !important;
}
</style>
    <div class="w-full max-w-sm bg-black/20 backdrop-blur-xl border border-white/10 rounded-3xl shadow-2xl p-8 flex flex-col items-center animate-fade-in" style="transform: translateY(-8vh);">
        <!-- Profile Icon -->
        <span class="inline-flex items-center justify-center w-16 h-16 rounded-full shadow-lg border border-white/10 bg-black/30 mb-6" style="background: rgba(20,20,20,0.22);">
            <svg width="40" height="40" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="16" cy="16" r="14" stroke="white" stroke-width="2" fill="rgba(255,255,255,0.08)"/>
                <path d="M16 18c3.314 0 6-2.686 6-6s-2.686-6-6-6-6 2.686-6 6 2.686 6 6 6zm0 2c-4.418 0-8 2.239-8 5v1a1 1 0 001 1h14a1 1 0 001-1v-1c0-2.761-3.582-5-8-5z" fill="white" fill-opacity="0.8"/>
            </svg>
        </span>
        <!-- User Info -->
        <div class="text-center mb-8">
            <form id="name-form" method="post" action="" class="flex flex-col items-center gap-2">
                {% csrf_token %}
                <input id="full-name-input" type="text" name="full_name" value="{{ user.get_full_name|default:user.username }}" placeholder="Your Name"
                    maxlength="10"
                    class="text-xl font-bold text-white bg-black/30 border border-white/10 rounded-xl px-4 py-2 text-center focus:outline-none focus:ring-2 focus:ring-green-400/40 backdrop-blur-lg placeholder-gray-400 transition-all duration-200 w-56 mb-1" autocomplete="off" />
            </form>
            <script>
            // Auto-save name on blur (AJAX), max 10 chars
            document.addEventListener('DOMContentLoaded', function() {
                const nameInput = document.getElementById('full-name-input');
                const form = document.getElementById('name-form');
                if (nameInput && form) {
                    nameInput.addEventListener('blur', function() {
                        const val = nameInput.value.trim();
                        if (val.length > 0 && val.length <= 10) {
                            fetch('', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                    'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
                                },
                                body: new URLSearchParams({ full_name: val })
                            }).then(r => {
                                // Optionally show a subtle success indicator
                                nameInput.classList.add('ring-2', 'ring-green-400');
                                setTimeout(() => nameInput.classList.remove('ring-2', 'ring-green-400'), 900);
                            });
                        }
                    });
                }
            });
            </script>
            <p class="text-gray-300 text-sm mt-3">{{ request.user.email|default:request.user.username }}</p>
        </div>
        <!-- Spacer -->
        <div class="flex-1"></div>
        <!-- Logout Button -->
        <form method="post" action="{% url 'account_logout' %}" class="w-full mt-8">
            {% csrf_token %}
            <button type="submit" class="w-full bg-black/40 hover:bg-white/10 text-white font-semibold py-3 px-4 rounded-xl shadow-lg transition-all duration-300 border border-white/10 backdrop-blur-lg">
                <span class="text-red-500 font-bold">Logout</span>
            </button>
        </form>
            <!-- Copyright & Credits -->
            <div class="w-full text-center mt-8 mb-2">
                <p class="text-xs text-gray-400/70 font-medium tracking-wide select-none" style="letter-spacing: 0.04em;">
                    &copy; 2026 Kya Main Zinda Hoon - AJ<br>
                </p>
            </div>
    </div>
</div>
<script>
document.getElementById('invite-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        showMessagePopup(data.success, data.message);
        if (data.success) {
            // Reload the page after a short delay to show the updated paired users
            setTimeout(() => window.location.reload(), 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessagePopup(false, 'An error occurred. Please try again.');
    });
});
</script>
{% endblock %}
