{% extends 'core/base.html' %}
{% block dashboard_noscroll %}
<style>body { overflow: hidden !important; }</style>
{% endblock %}
{% load static %}

<style>
    /* Disable text selection only in dashboard content */
    .dashboard-no-select, .dashboard-no-select * {
        user-select: none !important;
        -webkit-user-select: none !important;
        -moz-user-select: none !important;
        -ms-user-select: none !important;
        -webkit-touch-callout: none !important;
    }
    /* Center content in visible area (above bottom nav); reserve space for nav */
    .dashboard-main {
        min-height: calc(100vh - 6rem);
        min-height: calc(100dvh - 6rem);
    }
    @media (max-width: 430px) {
        .dashboard-main {
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 0;
            padding-bottom: 0;
            min-height: calc(100vh - 6rem - env(safe-area-inset-bottom, 0px));
            min-height: calc(100dvh - 6rem - env(safe-area-inset-bottom, 0px));
            gap: 0.75rem;
        }
        .dashboard-title { font-size: 1.5rem; padding: 0.5rem 1rem; }
        .dashboard-loader-btn { width: min(72vw, 17rem); height: min(72vw, 17rem); min-width: 12rem; min-height: 12rem; }
        .dashboard-loader-number { font-size: 5rem; }
        .dashboard-status-card { padding: 0.75rem 1rem; gap: 0.75rem; }
    }
</style>
{% block content %}
{% include 'core/app_icon.html' %}
<div class="dashboard-no-select dashboard-main w-full flex flex-col items-center justify-center px-4 sm:px-6 md:px-12 pt-4 sm:pt-6 pb-6 sm:pb-8 gap-4 sm:gap-6 bg-gradient-to-br from-black via-gray-900 to-gray-800">
    <!-- Glassy Title Above Loader -->
    <div class="flex flex-col items-center gap-4 sm:gap-6 w-full mt-0 sm:mt-2 -translate-y-12 pt-12 sm:pt-16">
        <div class="mb-0 sm:mb-1 w-full flex flex-col items-center gap-2 px-1">
            <span class="dashboard-title block text-2xl sm:text-3xl md:text-5xl font-extrabold tracking-tight text-white/90 px-4 sm:px-6 md:px-8 py-3 sm:py-4 rounded-2xl sm:rounded-3xl shadow-2xl border border-white/10 bg-black/40 backdrop-blur-2xl"
                style="background: rgba(20,20,20,0.18); font-family: 'Inter', 'Segoe UI', 'Arial', sans-serif; letter-spacing: 0.01em;">
                Am I Ok?
            </span>
            <p class="text-sm sm:text-base text-white/50 font-medium tracking-wide text-center max-w-xs">Let friends know you're okay</p>
        </div>
        <div class="relative flex flex-col items-center justify-center w-full mt-0 gap-2">
            <button id="loader-btn" class="dashboard-loader-btn relative w-64 h-64 sm:w-72 sm:h-72 flex items-center justify-center rounded-full border-2 border-white/20 bg-black/40 shadow-2xl backdrop-blur-2xl transition-all duration-300 hover:scale-105 active:scale-95 group overflow-hidden"
                style="box-shadow: 0 16px 64px 0 rgba(0,0,0,0.28);">
                <!-- Animated SVG Ring -->
                <svg class="absolute inset-0 w-full h-full" width="288" height="288" viewBox="0 0 288 288">
                    <circle cx="144" cy="144" r="126" stroke="#fff" stroke-width="14" fill="none" opacity="0.10" />
                    <circle id="loader-ring" cx="144" cy="144" r="126" stroke="#fff" stroke-width="14" fill="none" stroke-linecap="round" stroke-dasharray="791.6813" stroke-dashoffset="791.6813" style="transition: stroke-dashoffset 0.18s cubic-bezier(.4,0,.2,1);" />
                </svg>
                <span id="loader-number" class="dashboard-loader-number text-8xl sm:text-9xl font-extrabold text-white drop-shadow-2xl select-none transition-all duration-200 z-10">100</span>
                <span id="loader-tick" style="display:none;"
                    class="absolute inset-0 flex items-center justify-center z-20">
                    <span class="relative flex items-center justify-center w-28 h-28 sm:w-36 sm:h-36 md:w-40 md:h-40 rounded-full shadow-2xl border border-green-300/30 bg-gradient-to-br from-green-400/30 via-green-300/20 to-white/10 backdrop-blur-2xl animate-tick-pop">
                        <!-- Glowing animated ring -->
                        <span class="absolute inset-0 rounded-full pointer-events-none animate-tick-glow" style="box-shadow: 0 0 32px 8px #22ff78cc, 0 0 0 8px #22ff7833;"></span>
                        <!-- Glass inner layer -->
                        <span class="absolute inset-2 rounded-full bg-white/10 backdrop-blur-md border border-white/10"></span>
                        <!-- Stylish SVG Tick -->
                        <svg class="w-16 h-16 sm:w-20 sm:h-20 md:w-[80px] md:h-[80px]" width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg" class="relative z-10">
                            <circle cx="40" cy="40" r="36" stroke="#22ff78" stroke-width="5" fill="rgba(34,255,120,0.10)" filter="url(#tick-glow)" />
                            <path d="M24 44L37 57L58 28" stroke="#22ff78" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" filter="url(#tick-glow)"/>
                            <defs>
                                <filter id="tick-glow" x="-10" y="-10" width="100" height="100" filterUnits="userSpaceOnUse">
                                    <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                        </svg>
                    </span>
                </span>
                <style>
                @keyframes tick-pop {
                    0% { transform: scale(0.7); opacity: 0; }
                    60% { transform: scale(1.08); opacity: 1; }
                    100% { transform: scale(1); opacity: 1; }
                }
                .animate-tick-pop {
                    animation: tick-pop 0.5s cubic-bezier(.4,0,.2,1) both;
                }
                @keyframes tick-glow {
                    0%, 100% { box-shadow: 0 0 32px 8px #22ff78cc, 0 0 0 8px #22ff7833; }
                    50% { box-shadow: 0 0 48px 16px #22ff78ee, 0 0 0 12px #22ff7855; }
                }
                .animate-tick-glow {
                    animation: tick-glow 1.5s ease-in-out infinite;
                }
                </style>
            </button>
            <audio id="loader-sound" src="{% static 'sounds/checkin_sound.wav' %}"></audio>
            <p class="text-xs sm:text-sm text-white/40 mt-1 text-center">Press and hold to mark attendance</p>
            <!-- SOS Emergency button (red + disabled when active SOS; gray + disabled when no contacts; else enabled) -->
            <div class="relative inline-block mt-4 group/sos">
                <button type="button" id="sos-trigger-btn" class="sos-trigger-btn px-5 py-2.5 rounded-2xl border backdrop-blur-2xl font-semibold text-sm tracking-wide shadow-xl transition-all duration-300 touch-manipulation {% if has_active_sos_sent %}bg-red-500/80 border-red-400/60 text-white cursor-not-allowed hover:scale-100 active:scale-100{% elif not has_emergency_contacts %}border border-white/20 bg-black/40 text-white/90 opacity-50 cursor-not-allowed hover:scale-100 hover:bg-black/40 hover:border-white/20 active:scale-100 active:bg-black/40 active:border-white/20{% else %}border border-white/20 bg-black/40 text-white/90 hover:scale-125 hover:bg-red-500/80 hover:border-red-400/50 hover:text-white active:scale-125 active:bg-red-500/80 active:border-red-400/50 active:text-white{% endif %}"
                    {% if not has_emergency_contacts or has_active_sos_sent %}disabled{% endif %}
                    data-share-location-in-sos="{% if profile.share_location_in_sos %}true{% else %}false{% endif %}">
                    SOS — Emergency
                </button>
                <div id="sos-tooltip" class="sos-tooltip absolute left-1/2 -translate-x-1/2 bottom-full mb-2 px-4 py-2.5 rounded-xl border border-white/15 bg-black/70 backdrop-blur-xl shadow-2xl text-center pointer-events-none opacity-0 invisible translate-y-1.5 transition-all duration-200 ease-out group-hover/sos:opacity-100 group-hover/sos:visible group-hover/sos:translate-y-0 whitespace-nowrap" style="{% if has_emergency_contacts and not has_active_sos_sent %}display:none;{% endif %}">
                    <span id="sos-tooltip-text" class="text-xs font-medium text-white/90 tracking-wide">{% if has_active_sos_sent %}You have an active SOS. Wait for someone to resolve it.{% else %}Add emergency contacts{% endif %}</span>
                    <span class="sos-tooltip-arrow absolute left-1/2 -translate-x-1/2 top-full mt-px w-0 h-0 border-l-[6px] border-r-[6px] border-t-[6px] border-l-transparent border-r-transparent border-t-black/70"></span>
                </div>
            </div>
        </div>

        <!-- You triggered an SOS (triggerer sees this until someone resolves) -->
        {% if has_active_sos_sent %}
        <div class="w-full max-w-md mx-auto mt-3 px-2 animate-fade-in">
            <div class="rounded-2xl border-2 border-amber-500/40 bg-amber-500/10 backdrop-blur-xl py-3 px-4 flex items-center gap-3">
                <span class="flex-shrink-0 w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center">
                    <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                </span>
                <div>
                    <p class="text-amber-200 font-semibold text-sm">You have triggered an SOS</p>
                    <p class="text-amber-200/70 text-xs mt-0.5">Your emergency contacts have been notified. Wait for someone to mark it resolved. You cannot send another until this one is resolved.</p>
                </div>
            </div>
        </div>
        {% endif %}

        {% if profile and profile.last_check_in %}
        <div class="w-full max-w-lg mx-auto mt-1 sm:mt-2 mb-4 flex justify-center">
            {% if profile.snooze_enabled %}
                {% with status="Paused" %}
                    <div class="dashboard-status-card rounded-2xl sm:rounded-3xl shadow-2xl border border-white/10 bg-black/60 backdrop-blur-2xl py-4 sm:py-6 flex items-center gap-3 sm:gap-5 animate-fade-in px-3 sm:px-4">
                        <span id="status-dot" class="inline-block w-5 h-5 rounded-full bg-gray-500 shadow-lg"></span>
                        <div>
                            <div class="text-lg sm:text-xl font-bold text-white">Status: <span id="status-text" class="capitalize text-gray-400">{{ status }}</span></div>
                            <div id="check-in-time" class="text-xs sm:text-sm text-gray-200">Check-in: {{ profile.last_check_in|timesince }} ago</div>
                        </div>
                    </div>
                {% endwith %}
            {% elif profile.is_missing %}
                {% with status="Danger" color="red" %}
                    <div class="dashboard-status-card rounded-2xl sm:rounded-3xl shadow-2xl border border-white/10 bg-black/60 backdrop-blur-2xl py-4 sm:py-6 flex items-center gap-3 sm:gap-5 animate-fade-in px-3 sm:px-4">
                        <span id="status-dot" class="inline-block w-5 h-5 rounded-full bg-red-500 shadow-lg animate-pulse"></span>
                        <div>
                            <div class="text-lg sm:text-xl font-bold text-white">Status: <span id="status-text" class="capitalize text-red-400">{{ status }}</span></div>
                            <div id="check-in-time" class="text-xs sm:text-sm text-gray-200">Check-in: {{ profile.last_check_in|timesince }} ago</div>
                        </div>
                    </div>
                {% endwith %}
            {% elif profile.is_warning %}
                {% with status="Warning" color="yellow" %}
                    <div class="dashboard-status-card rounded-2xl sm:rounded-3xl shadow-2xl border border-white/10 bg-black/60 backdrop-blur-2xl py-4 sm:py-6 flex items-center gap-3 sm:gap-5 animate-fade-in px-3 sm:px-4">
                        <span id="status-dot" class="inline-block w-5 h-5 rounded-full bg-yellow-400 shadow-lg"></span>
                        <div>
                            <div class="text-lg sm:text-xl font-bold text-white">Status: <span id="status-text" class="capitalize text-yellow-300">{{ status }}</span></div>
                            <div id="check-in-time" class="text-xs sm:text-sm text-gray-200">Check-in: {{ profile.last_check_in|timesince }} ago</div>
                        </div>
                    </div>
                {% endwith %}
            {% else %}
                {% with status="Active" color="green" %}
                    <div class="dashboard-status-card rounded-2xl sm:rounded-3xl shadow-2xl border border-white/10 bg-black/60 backdrop-blur-2xl py-4 sm:py-6 flex items-center gap-3 sm:gap-5 animate-fade-in px-3 sm:px-4">
                        <span id="status-dot" class="inline-block w-5 h-5 rounded-full bg-green-400 shadow-lg"></span>
                        <div>
                            <div class="text-lg sm:text-xl font-bold text-white">Status: <span id="status-text" class="capitalize text-green-400">{{ status }}</span></div>
                            <div id="check-in-time" class="text-xs sm:text-sm text-gray-200">Check-in: {{ profile.last_check_in|timesince }} ago</div>
                        </div>
                    </div>
                {% endwith %}
            {% endif %}
        </div>
        {% endif %}
        <!-- Quick tip / reminder -->
        <div class="w-full max-w-md mx-auto mt-2 sm:mt-4 px-4">
            <div class="rounded-2xl border border-white/8 bg-black/30 backdrop-blur-xl py-3 px-4 flex items-center gap-3">
                <span class="flex-shrink-0 w-9 h-9 rounded-full bg-white/10 flex items-center justify-center">
                    <svg class="w-4 h-4 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </span>
                <p class="text-xs sm:text-sm text-white/50 leading-snug">Check in regularly to stay Active.</p>
            </div>
        </div>
</div>

<!-- SOS 10-second countdown modal (sender) -->
<div id="sos-countdown-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-md p-4" style="display:none;">
    <div class="rounded-3xl border border-white/15 bg-black/60 backdrop-blur-2xl shadow-2xl px-8 py-8 flex flex-col items-center gap-6 max-w-sm w-full animate-pop">
        <div class="text-center">
            <p class="text-white/90 font-semibold text-lg mb-1">Emergency SOS</p>
            <p class="text-white/60 text-sm">Sending in <span id="sos-countdown-num" class="font-bold text-white">10</span> seconds. Cancel if this was accidental.</p>
        </div>
        <div class="w-20 h-20 rounded-full border-2 border-white/30 bg-white/5 flex items-center justify-center">
            <span id="sos-countdown-circle" class="text-3xl font-bold text-white">10</span>
        </div>
        <button type="button" id="sos-countdown-cancel" class="w-full py-3 rounded-2xl border border-white/20 bg-white/10 text-white font-medium hover:bg-white/20 transition-all duration-300">Cancel</button>
    </div>
</div>

<!-- SOS: recipient alerts + triggerer resolved notifications (stacked at top of home) -->
<div id="sos-dashboard-notifications" class="fixed top-4 left-4 right-4 z-[55] flex flex-col gap-3 max-w-md mx-auto">
    <div id="sos-alerts-container" class="flex flex-col gap-3" style="display:none;"></div>
    <div id="sos-resolved-notifications-container" class="flex flex-col gap-3" style="display:none;"></div>
</div>

<!-- Resolve confirmation modal -->
<div id="sos-resolve-modal" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/50 backdrop-blur-md p-4" style="display:none;">
    <div class="rounded-3xl border border-white/15 bg-black/60 backdrop-blur-2xl shadow-2xl px-6 py-6 max-w-sm w-full animate-pop">
        <p class="text-white/90 font-semibold mb-2">Mark SOS as resolved?</p>
        <p class="text-white/60 text-sm mb-4 leading-relaxed">If you mark this as resolved: the emergency alert will be closed, and the sender will no longer see this as an active SOS. Only mark resolved when you have confirmed they are safe.</p>
        <div class="flex gap-3">
            <button type="button" id="sos-resolve-cancel" class="flex-1 py-2.5 rounded-xl border border-white/20 bg-white/10 text-white text-sm font-medium">Cancel</button>
            <button type="button" id="sos-resolve-confirm" class="flex-1 py-2.5 rounded-xl bg-white/20 border border-white/20 text-white text-sm font-semibold hover:bg-white/30 transition-all">Resolve</button>
        </div>
    </div>
</div>

        <script>
        const loaderBtn = document.getElementById('loader-btn');
        const loaderNumber = document.getElementById('loader-number');
        const loaderRing = document.getElementById('loader-ring');
        const loaderSound = document.getElementById('loader-sound');
        let interval = null;
        let value = 0;
        let animating = false;
        function setNumber(val) {
            value = val;
            const tick = document.getElementById('loader-tick');
            if (val >= 100) {
                loaderNumber.style.display = 'none';
                if (loaderRing) loaderRing.style.display = 'none';
                if (tick) tick.style.display = '';
                setTimeout(() => {
                    if (tick) tick.style.display = 'none';
                    loaderNumber.style.display = '';
                    setNumber(0);
                }, 5000);
                // Update last check-in time (with optional location if sharing enabled)
                var shareLocation = {{ profile.share_location_with_friends|yesno:"true,false" }};
                function doCheckIn(lat, lng) {
                    var opts = { method: 'POST', headers: { 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content } };
                    if (lat != null && lng != null) {
                        opts.headers['Content-Type'] = 'application/json';
                        opts.body = JSON.stringify({ lat: lat, lng: lng });
                    }
                    fetch('{% url "check_in" %}', opts)
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                    if (data.status !== 'success') {
                        if (typeof showMessagePopup === 'function') showMessagePopup(false, 'Check-in failed. Please try again.');
                        return;
                    }
                    // Update status card without reload
                    const dot = document.getElementById('status-dot');
                    if (dot) {
                        dot.className = 'inline-block w-5 h-5 rounded-full bg-green-400 shadow-lg';
                    }
                    const statusSpan = document.getElementById('status-text');
                    if (statusSpan) statusSpan.textContent = 'Active';
                    const checkInDiv = document.getElementById('check-in-time');
                    if (checkInDiv) checkInDiv.textContent = 'Check-in: Just now';
                    // Confirm 100% attendance marked
                    if (typeof showMessagePopup === 'function') showMessagePopup(true, 'Attendance marked · 100%');
                    // Play sound, then vibrate after sound ends
                    loaderSound.currentTime = 0;
                    const vibrateAfterSound = function() {
                        if (navigator.vibrate) navigator.vibrate(200);
                        loaderSound.removeEventListener('ended', vibrateAfterSound);
                    };
                    loaderSound.addEventListener('ended', vibrateAfterSound);
                    loaderSound.play();
                })
                .catch(function() {
                    if (typeof showMessagePopup === 'function') showMessagePopup(false, 'Check-in failed. Please try again.');
                });
                }
                if (shareLocation && navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(pos) { doCheckIn(pos.coords.latitude, pos.coords.longitude); },
                        function() { doCheckIn(null, null); },
                        { timeout: 10000, maximumAge: 60000 }
                    );
                } else {
                    doCheckIn(null, null);
                }
                return;
            } else {
                if (tick) tick.style.display = 'none';
                loaderNumber.style.display = '';
            }
            loaderNumber.textContent = Math.round(val);
            // Animate SVG ring
            if (loaderRing) {
                // Circumference = 2 * PI * r = 2 * 3.1416 * 126 = ~791.6813
                const circ = 2 * Math.PI * 126;
                const percent = Math.max(0, Math.min(1, val / 100));
                loaderRing.style.strokeDashoffset = (1 - percent) * circ;
                // Hide only after animation completes
                if (percent === 0) {
                    setTimeout(() => {
                        if (value === 0) loaderRing.style.display = 'none';
                    }, 180); // match transition duration
                } else {
                    loaderRing.style.display = '';
                }
            }
        }
        function animateTo(target, duration, cb) {
            if (interval) clearInterval(interval);
            const start = value;
            const diff = target - start;
            const steps = Math.round(duration / 16);
            let current = 0;
            interval = setInterval(() => {
                current++;
                const v = start + diff * (current / steps);
                setNumber(v);
                if (current >= steps) {
                    setNumber(target);
                    clearInterval(interval);
                    interval = null;
                    if (cb) cb();
                }
            }, 16);
        }
        let holdTimeout = null;
        let startTime = null;
        let completed = false;
        function startHold() {
            if (animating) return;
            completed = false;
            startTime = Date.now();
            animateTo(0, 0, () => {
                animateTo(100, 1000, () => {
                    completed = true;
                });
            });
        }
        function endHold() {
            if (animating) return;
            if (completed) return;
            if (interval) clearInterval(interval);
            animateTo(0, 400);
        }
        loaderBtn.addEventListener('mousedown', startHold);
        loaderBtn.addEventListener('touchstart', startHold);
        loaderBtn.addEventListener('mouseup', endHold);
        loaderBtn.addEventListener('touchend', endHold);
        loaderBtn.addEventListener('touchcancel', endHold);
        setNumber(0);
        </script>

        <!-- SOS: 10s countdown then trigger -->
        <script>
        (function() {
            var modal = document.getElementById('sos-countdown-modal');
            var numEl = document.getElementById('sos-countdown-num');
            var circleEl = document.getElementById('sos-countdown-circle');
            var cancelBtn = document.getElementById('sos-countdown-cancel');
            var triggerBtn = document.getElementById('sos-trigger-btn');
            var countdownTimer = null;
            var secondsLeft = 10;

            function stopCountdown() {
                if (countdownTimer) clearInterval(countdownTimer);
                countdownTimer = null;
                modal.style.display = 'none';
            }

            function runCountdown() {
                if (triggerBtn && triggerBtn.disabled) return;
                secondsLeft = 10;
                numEl.textContent = circleEl.textContent = '10';
                modal.style.display = 'flex';
                countdownTimer = setInterval(function() {
                    secondsLeft--;
                    numEl.textContent = circleEl.textContent = secondsLeft;
                    if (secondsLeft <= 0) {
                        stopCountdown();
                        var doTrigger = function(body) {
                            var opts = {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(body || {})
                            };
                            fetch('{% url "sos_trigger" %}', opts)
                                .then(function(r) { return r.json(); })
                                .then(function(data) {
                                    if (data.success) { location.reload(); return; }
                                    if (typeof showMessagePopup === 'function') showMessagePopup(false, data.message || 'Failed to send SOS.');
                                })
                                .catch(function() {
                                    if (typeof showMessagePopup === 'function') showMessagePopup(false, 'Failed to send SOS.');
                                });
                        };
                        if (navigator.geolocation) {
                            navigator.geolocation.getCurrentPosition(
                                function(pos) {
                                    doTrigger({ lat: pos.coords.latitude, lng: pos.coords.longitude });
                                },
                                function() {
                                    doTrigger({});
                                    if (typeof showMessagePopup === 'function') showMessagePopup(false, 'SOS sent without location. Grant location when triggering to share with emergency contacts.');
                                },
                                { timeout: 12000, maximumAge: 60000 }
                            );
                        } else {
                            doTrigger({});
                        }
                    }
                }, 1000);
            }

            if (triggerBtn) triggerBtn.addEventListener('click', runCountdown);
            if (cancelBtn) cancelBtn.addEventListener('click', stopCountdown);
        })();
        </script>

        <!-- SOS: enable/disable button based on emergency contacts and active SOS sent -->
        <script>
        (function() {
            var triggerBtn = document.getElementById('sos-trigger-btn');
            var tooltip = document.getElementById('sos-tooltip');
            var tooltipText = document.getElementById('sos-tooltip-text');
            if (!triggerBtn) return;

            function updateSosButtonState() {
                fetch('{% url "sos_has_emergency_contacts" %}')
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        var canTrigger = data.has_emergency_contacts && !data.has_active_sos_sent;
                        var activeSos = data.has_active_sos_sent;
                        // Remove all state-specific classes first
                        triggerBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'hover:scale-100', 'hover:bg-black/40', 'hover:border-white/20', 'active:scale-100', 'active:bg-black/40', 'active:border-white/20', 'hover:scale-125', 'hover:bg-red-500/80', 'hover:border-red-400/50', 'hover:text-white', 'active:scale-125', 'active:bg-red-500/80', 'active:border-red-400/50', 'active:text-white', 'bg-red-500/80', 'border-red-400/60', 'text-white', 'border', 'border-white/20', 'bg-black/40', 'text-white/90');
                        if (canTrigger) {
                            triggerBtn.disabled = false;
                            triggerBtn.classList.add('border', 'border-white/20', 'bg-black/40', 'text-white/90', 'hover:scale-125', 'hover:bg-red-500/80', 'hover:border-red-400/50', 'hover:text-white', 'active:scale-125', 'active:bg-red-500/80', 'active:border-red-400/50', 'active:text-white');
                            if (tooltip) { tooltip.style.display = 'none'; }
                        } else {
                            triggerBtn.disabled = true;
                            triggerBtn.classList.add('cursor-not-allowed', 'hover:scale-100', 'active:scale-100');
                            if (activeSos) {
                                triggerBtn.classList.add('border', 'bg-red-500/80', 'border-red-400/60', 'text-white');
                            } else {
                                triggerBtn.classList.add('border', 'border-white/20', 'bg-black/40', 'text-white/90', 'opacity-50', 'hover:bg-black/40', 'hover:border-white/20', 'active:bg-black/40', 'active:border-white/20');
                            }
                            if (tooltip) {
                                tooltip.style.display = '';
                                if (tooltipText) tooltipText.textContent = activeSos ? 'You have an active SOS. Wait for someone to resolve it.' : 'Add emergency contacts';
                            }
                        }
                    })
                    .catch(function() {});
            }

            updateSosButtonState();
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible') updateSosButtonState();
            });
        })();
        </script>

        <!-- SOS: recipient alerts + poll + resolve -->
        <script>
        (function() {
            var container = document.getElementById('sos-alerts-container');
            var resolveModal = document.getElementById('sos-resolve-modal');
            var resolveCancelBtn = document.getElementById('sos-resolve-cancel');
            var resolveConfirmBtn = document.getElementById('sos-resolve-confirm');
            var resolveAlertId = null;
            var pollInterval = 15000;

            function csrfHeader() {
                var meta = document.querySelector('meta[name="csrf-token"]');
                return meta ? meta.content : '';
            }

            function renderAlerts(alerts) {
                if (!alerts || alerts.length === 0) {
                    container.style.display = 'none';
                    container.innerHTML = '';
                    return;
                }
                container.style.display = 'flex';
                container.innerHTML = alerts.map(function(a) {
                    var timeStr = formatSosTime(a.created_at);
                    var locationLine = a.location ? ('<p class="text-xs text-white/50 mt-1"><span class="text-white/60">Last known location:</span> ' + escapeHtml(a.location) + '</p>') : '';
                    var contactLine = a.from_email ? ('<p class="text-xs text-white/50 mt-0.5">Contact: ' + escapeHtml(a.from_email) + '</p>') : '';
                    var hasCoords = typeof a.lat === 'number' && typeof a.lng === 'number';
                    var latAttr = hasCoords ? (' data-lat="' + a.lat + '"') : '';
                    var lngAttr = hasCoords ? (' data-lng="' + a.lng + '"') : '';
                    var locateBtn = '<button type="button" class="sos-alert-locate py-2 px-4 rounded-xl border border-white/20 bg-white/10 text-white text-sm font-medium hover:bg-white/20 transition-all flex-shrink-0" title="Open in Google Maps"' + latAttr + lngAttr + '>Locate</button>';
                    return '<div class="sos-alert-card rounded-2xl border-2 border-red-500/50 bg-black/50 backdrop-blur-2xl shadow-2xl px-4 py-4 flex flex-col sm:flex-row gap-3 animate-pop" data-alert-id="' + a.id + '">' +
                        '<div class="flex-1 min-w-0 order-1">' +
                        '<p class="font-semibold text-white/95">' +
                        '<span class="text-red-400 font-bold">' + escapeHtml(a.from_name || a.from_username || a.from_email || 'Someone') + '</span> needs help</p>' +
                        '<p class="text-xs text-white/50 mt-0.5">Emergency SOS · ' + timeStr + '</p>' +
                        contactLine +
                        locationLine +
                        '</div>' +
                        '<div class="flex items-center gap-2 flex-shrink-0 order-2 sm:order-3">' +
                        '<button type="button" class="sos-alert-dismiss w-9 h-9 rounded-xl border border-white/15 bg-white/5 flex items-center justify-center text-white/70 hover:bg-white/15 transition-all" title="Dismiss">×</button>' +
                        locateBtn +
                        '<button type="button" class="sos-alert-resolve py-2 px-4 rounded-xl border border-white/20 bg-white/15 text-white text-sm font-medium hover:bg-white/25 transition-all">Resolve</button>' +
                        '</div>' +
                        '</div>';
                }).join('');

                container.querySelectorAll('.sos-alert-dismiss').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var card = btn.closest('.sos-alert-card');
                        if (card) card.style.display = 'none';
                    });
                });
                container.querySelectorAll('.sos-alert-locate').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var lat = btn.getAttribute('data-lat');
                        var lng = btn.getAttribute('data-lng');
                        if (lat != null && lng != null) {
                            var url = 'https://www.google.com/maps?q=' + encodeURIComponent(lat) + ',' + encodeURIComponent(lng);
                            window.open(url, '_blank', 'noopener,noreferrer');
                        } else {
                            if (typeof showMessagePopup === 'function') showMessagePopup(false, 'Location was not shared by the sender.');
                        }
                    });
                });
                container.querySelectorAll('.sos-alert-resolve').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var card = btn.closest('.sos-alert-card');
                        if (!card) return;
                        resolveAlertId = card.getAttribute('data-alert-id');
                        resolveModal.style.display = 'flex';
                    });
                });
            }

            function escapeHtml(s) {
                var div = document.createElement('div');
                div.textContent = s;
                return div.innerHTML;
            }

            function formatSosTime(isoString) {
                if (!isoString) return '';
                var d = new Date(isoString);
                var now = new Date();
                var sec = Math.floor((now - d) / 1000);
                if (sec < 60) return 'Just now';
                var min = Math.floor(sec / 60);
                if (min < 60) return min === 1 ? '1 min ago' : min + ' min ago';
                var hr = Math.floor(min / 60);
                if (hr < 24) return hr === 1 ? '1 hr ago' : hr + ' hr ago';
                var day = Math.floor(hr / 24);
                if (day < 7) return day === 1 ? 'Yesterday' : day + ' days ago';
                return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
            }

            function fetchAlerts() {
                fetch('{% url "sos_list" %}')
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        renderAlerts(data.alerts || []);
                    })
                    .catch(function() {});
            }

            if (resolveCancelBtn) resolveCancelBtn.addEventListener('click', function() {
                resolveModal.style.display = 'none';
                resolveAlertId = null;
            });
            if (resolveConfirmBtn) resolveConfirmBtn.addEventListener('click', function() {
                if (!resolveAlertId) return;
                var alertId = parseInt(resolveAlertId, 10);
                if (isNaN(alertId)) {
                    if (typeof showMessagePopup === 'function') showMessagePopup(false, 'Invalid alert.');
                    return;
                }
                fetch('{% url "sos_resolve" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfHeader()
                    },
                    body: JSON.stringify({ alert_id: alertId })
                })
                    .then(function(r) {
                        return r.text().then(function(text) {
                            var data = {};
                            try { data = JSON.parse(text); } catch (e) {}
                            if (!r.ok) throw new Error(data.message || 'Failed to resolve.');
                            return data;
                        });
                    })
                    .then(function(data) {
                        resolveModal.style.display = 'none';
                        resolveAlertId = null;
                        fetchAlerts();
                        if (data.success && typeof showMessagePopup === 'function') showMessagePopup(true, 'SOS marked as resolved.');
                    })
                    .catch(function(err) {
                        resolveModal.style.display = 'none';
                        resolveAlertId = null;
                        fetchAlerts();
                        if (typeof showMessagePopup === 'function') showMessagePopup(false, err.message || 'Failed to resolve.');
                    });
            });

            fetchAlerts();
            setInterval(fetchAlerts, pollInterval);
        })();
        </script>

        <!-- SOS resolved notifications (alert on home for triggerer, with full info) -->
        <script>
        (function() {
            var container = document.getElementById('sos-resolved-notifications-container');
            if (!container) return;

            function csrfHeader() {
                var meta = document.querySelector('meta[name="csrf-token"]');
                return meta ? meta.content : '';
            }

            function escapeHtml(s) {
                var div = document.createElement('div');
                div.textContent = s;
                return div.innerHTML;
            }

            function formatResolvedTime(isoString) {
                if (!isoString) return '';
                var d = new Date(isoString);
                var now = new Date();
                var sec = Math.floor((now - d) / 1000);
                if (sec < 60) return 'Just now';
                var min = Math.floor(sec / 60);
                if (min < 60) return min === 1 ? '1 min ago' : min + ' min ago';
                var hr = Math.floor(min / 60);
                if (hr < 24) return hr === 1 ? '1 hr ago' : hr + ' hr ago';
                var day = Math.floor(hr / 24);
                if (day < 7) return day === 1 ? 'Yesterday' : day + ' days ago';
                return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
            }

            function renderResolvedNotifications(notifications) {
                if (!notifications || notifications.length === 0) {
                    container.style.display = 'none';
                    container.innerHTML = '';
                    return;
                }
                container.style.display = 'flex';
                container.innerHTML = notifications.map(function(n) {
                    var name = n.resolved_by_name || n.resolved_by_username || n.resolved_by_email || 'an emergency contact';
                    var timeStr = formatResolvedTime(n.resolved_at);
                    var contactLine = n.resolved_by_email ? ('<p class="text-xs text-white/50 mt-1"><span class="text-white/60">Contact:</span> ' + escapeHtml(n.resolved_by_email) + '</p>') : '';
                    return '<div class="sos-resolved-card rounded-2xl border-2 border-green-500/40 bg-black/50 backdrop-blur-2xl shadow-2xl px-4 py-4 flex items-start gap-3 animate-pop" data-notification-id="' + n.id + '">' +
                        '<span class="flex-shrink-0 w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center mt-0.5">' +
                        '<svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' +
                        '</span>' +
                        '<div class="flex-1 min-w-0">' +
                        '<p class="font-semibold text-green-300/95">SOS resolved</p>' +
                        '<p class="text-sm text-white/90 mt-0.5">Your SOS was marked as resolved by <span class="font-medium text-white">' + escapeHtml(name) + '</span>.</p>' +
                        '<p class="text-xs text-white/50 mt-1">Resolved ' + timeStr + '</p>' +
                        contactLine +
                        '</div>' +
                        '<button type="button" class="sos-resolved-dismiss flex-shrink-0 py-2 px-3 rounded-xl border border-green-400/30 bg-green-500/15 text-green-300 text-sm font-medium hover:bg-green-500/25 transition-all" data-id="' + n.id + '">Dismiss</button>' +
                        '</div>';
                }).join('');

                container.querySelectorAll('.sos-resolved-dismiss').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var id = parseInt(btn.getAttribute('data-id'), 10);
                        if (isNaN(id)) return;
                        fetch('{% url "sos_resolved_notifications_seen" %}', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfHeader() },
                            body: JSON.stringify({ ids: [id] })
                        }).then(function() { location.reload(); }).catch(function() { location.reload(); });
                    });
                });
            }

            function checkResolvedNotifications() {
                fetch('{% url "sos_resolved_notifications" %}')
                    .then(function(r) {
                        if (!r.ok) return r.text().then(function() { return { notifications: [] }; });
                        return r.json();
                    })
                    .then(function(data) {
                        if (data && data.notifications && data.notifications.length > 0) {
                            renderResolvedNotifications(data.notifications);
                        } else {
                            container.style.display = 'none';
                            container.innerHTML = '';
                        }
                    })
                    .catch(function() {
                        container.style.display = 'none';
                        container.innerHTML = '';
                    });
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    checkResolvedNotifications();
                });
            } else {
                checkResolvedNotifications();
            }
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible') checkResolvedNotifications();
            });
            // Poll so triggerer sees resolved alert without refreshing (e.g. dashboard already open)
            setInterval(checkResolvedNotifications, 15000);
        })();
        </script>

        <!-- Status Popup (Warning/Danger) - only when not snoozed -->
        {% if profile and profile.last_check_in %}
            {% if not profile.snooze_enabled %}
            {% if profile.is_missing or profile.is_warning %}
                <div id="status-popup" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm animate-pop p-4" style="display:none;">
                    <div class="relative bg-black/80 border border-white/10 rounded-2xl sm:rounded-3xl shadow-2xl px-5 py-6 sm:px-8 sm:py-8 flex flex-col items-center gap-3 sm:gap-4" style="min-width: 260px; max-width: min(90vw, 22rem);">
                        <button onclick="closeStatusPopup()" class="absolute top-3 right-3 text-white/60 hover:text-white/90 text-2xl focus:outline-none">&times;</button>
                        <div class="text-lg font-semibold text-white/80 mb-2 tracking-wide">
                            {% if profile.is_missing %}
                                <span class="text-red-400">Danger!</span>
                            {% else %}
                                <span class="text-yellow-300">Warning!</span>
                            {% endif %}
                        </div>
                        <div class="text-center text-white/70 text-base leading-relaxed">
                            {% if profile.is_missing %}
                                You have not checked in for over <b>48 hours</b>.<br>Immediate check-in is required to avoid alerting your friends!
                            {% else %}
                                You have not checked in for over <b>32 hours</b>.<br>Please check in soon to avoid entering danger status.
                            {% endif %}
                        </div>
                    </div>
                </div>
                <script>
                function closeStatusPopup() {
                    document.getElementById('status-popup').style.display = 'none';
                    localStorage.setItem('statusPopupShown', 'true');
                }
                document.addEventListener('DOMContentLoaded', function() {
                    if (!localStorage.getItem('statusPopupShown')) {
                        setTimeout(function() {
                            document.getElementById('status-popup').style.display = 'flex';
                        }, 600);
                    }
                });
                </script>
            {% endif %}
            {% endif %}
        {% endif %}

</div>

<meta name="csrf-token" content="{{ csrf_token }}">

<style>
@keyframes fade-in {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.animate-fade-in {
    animation: fade-in 0.6s cubic-bezier(.4, 0, .2, 1) both;
}

.animate-fade-in:nth-child(1) { animation-delay: 0.1s; }
.animate-fade-in:nth-child(2) { animation-delay: 0.2s; }
.animate-fade-in:nth-child(3) { animation-delay: 0.3s; }

@keyframes pop {
    0% {
        transform: scale(0.95);
        opacity: 0.8;
    }
    60% {
        transform: scale(1.02);
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

.animate-pop {
    animation: pop 0.5s cubic-bezier(.4, 0, .2, 1) both;
}

@keyframes pulse-glow {
    0%, 100% {
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
    }
    50% {
        box-shadow: 0 0 30px rgba(239, 68, 68, 0.6);
    }
}

#check-in-btn {
    animation: pop 0.5s cubic-bezier(.4, 0, .2, 1) both, pulse-glow 2s ease-in-out infinite;
}

@keyframes sos-pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
    50% { box-shadow: 0 0 0 8px rgba(239,68,68,0); }
}
.sos-alert-card {
    animation: sos-pulse 2s ease-in-out infinite;
    border-color: rgba(239,68,68,0.5) !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkInBtn = document.getElementById('check-in-btn');
    if (!checkInBtn) return;

    checkInBtn.addEventListener('click', function() {
        // Disable button during request
        checkInBtn.disabled = true;
        checkInBtn.classList.add('opacity-75', 'cursor-not-allowed');
        
        fetch('/KyaMainZindaHoon/check-in/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show success feedback
                checkInBtn.innerHTML = '<span class="relative z-10 flex items-center justify-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Check-in Successful!</span>';
                checkInBtn.classList.remove('from-red-600', 'to-red-700', 'hover:from-red-700', 'hover:to-red-800');
                checkInBtn.classList.add('from-green-600', 'to-green-700');
                
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                alert('Check-in failed. Please try again.');
                checkInBtn.disabled = false;
                checkInBtn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
            checkInBtn.disabled = false;
            checkInBtn.classList.remove('opacity-75', 'cursor-not-allowed');
        });
    });
});
</script>
{% endblock %}
