{% extends 'core/base.html' %}
{% load static %}

{% block content %}
{% include 'core/app_icon.html' %}
<div class="w-full min-h-screen flex flex-col items-center" style="align-items: center; margin-top: 0; padding-top: 2vh;">
    <!-- Card 1: Invite Code Input -->
    <div class="w-full max-w-sm bg-black/30 backdrop-blur-2xl border border-white/10 rounded-3xl shadow-2xl p-4 flex flex-row items-center gap-2 animate-fade-in" style="margin-top: 4vh; border-top-left-radius: 0; border-top-right-radius: 0;">
        <form id="invite-form" class="flex flex-row w-full items-center gap-2">
            {% csrf_token %}
            <input name="invite_code" type="text" maxlength="5" placeholder="Enter invite code" class="flex-1 px-4 py-2 rounded-xl bg-black/40 border border-white/10 text-white text-center placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-400/40 transition-all duration-200" autocomplete="off" required />
            <button type="submit" class="ml-2 px-5 py-2 rounded-xl bg-gradient-to-r from-black/60 to-white/10 text-white font-semibold shadow hover:bg-white/10 border border-white/10 transition-all duration-200 whitespace-nowrap">Join</button>
        </form>
    </div>

    <!-- Stylish Heading -->
    <div class="w-full max-w-sm flex justify-center items-center mt-8">
        <h2 class="text-xl md:text-2xl font-bold tracking-wide text-white/90 bg-gradient-to-r from-green-400/80 via-blue-400/80 to-purple-400/80 bg-clip-text text-transparent drop-shadow-lg text-center w-full py-2 rounded-xl">
            Friends & Connections
        </h2>
    </div>
    <!-- Card 2: Paired Users List -->
    <div class="w-full max-w-sm bg-black/30 backdrop-blur-2xl border border-white/10 rounded-3xl shadow-2xl p-4 animate-fade-in mt-4" style="max-height: 270px; overflow-y: auto;">
        {% if paired_users %}
            <ul class="w-full flex flex-col gap-3">
                {% for friend in paired_users %}
                    {% with friend_profile=friend.profile %}
                    <li class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 flex items-center justify-between shadow-sm cursor-pointer friend-item group"
                        data-name="{{ friend.get_full_name|default:friend.email|default:'Unknown' }}"
                        data-email="{{ friend.email }}"
                        data-status="{% if friend_profile.snooze_enabled %}Paused{% elif friend_profile.is_missing %}Danger{% elif friend_profile.is_warning %}Warning{% else %}Active{% endif %}"
                        data-joined="{{ friend.date_joined|date:'d M Y, g:i A' }}"
                        data-last-login="{% if friend.last_login %}{{ friend.last_login|date:'d M Y, g:i A' }}{% else %}â€”{% endif %}"
                        {% if friend_profile.share_location_with_friends and friend_profile.last_latitude is not None and friend_profile.last_longitude is not None %}data-lat="{{ friend_profile.last_latitude }}" data-lng="{{ friend_profile.last_longitude }}" data-location-updated="{{ friend_profile.location_updated_at|timesince }} ago"{% if friend_profile.last_city %} data-city="{{ friend_profile.last_city }}"{% endif %}{% if friend_profile.last_state %} data-state="{{ friend_profile.last_state }}"{% endif %}{% endif %}>
                        <span class="font-medium text-white/90 text-base">
                            {{ friend.get_full_name|default:friend.email|default:"Unknown" }}
                        </span>
                        {% if friend_profile.snooze_enabled %}
                            <span class="text-xs px-2 py-1 rounded bg-gray-500/20 text-gray-400 font-semibold tracking-wide">Paused</span>
                        {% elif friend_profile.is_missing %}
                            <span class="text-xs px-2 py-1 rounded bg-red-500/20 text-red-400 font-semibold tracking-wide">Danger</span>
                        {% elif friend_profile.is_warning %}
                            <span class="text-xs px-2 py-1 rounded bg-yellow-400/20 text-yellow-300 font-semibold tracking-wide">Warning</span>
                        {% else %}
                            <span class="text-xs px-2 py-1 rounded bg-green-500/20 text-green-300 font-semibold tracking-wide">Active</span>
                        {% endif %}
                    </li>
                    {% endwith %}
                {% endfor %}
            </ul>
        </div>
        <!-- Friend Details Modal -->
        <div id="friend-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden" style="backdrop-filter: blur(12px); background: rgba(0,0,0,0.5);">
            <div class="relative w-full max-w-sm rounded-3xl overflow-hidden flex flex-col items-center friend-modal-card"
                 style="background: linear-gradient(165deg, rgba(30,30,35,0.95) 0%, rgba(18,18,22,0.98) 100%); border: 1px solid rgba(255,255,255,0.12); box-shadow: 0 24px 48px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.05);">
                <button id="close-modal" class="absolute top-4 right-4 z-10 w-9 h-9 rounded-full flex items-center justify-center text-white/60 hover:text-white hover:bg-white/10 transition-all duration-200 text-xl font-light focus:outline-none" aria-label="Close">&times;</button>
                <div class="pt-8 pb-5 px-6 flex flex-col items-center w-full">
                    <div class="w-20 h-20 rounded-full flex items-center justify-center mb-4 ring-2 ring-white/20 shadow-xl"
                         style="background: linear-gradient(145deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);">
                        <svg width="44" height="44" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white/90">
                            <circle cx="32" cy="32" r="23" stroke="currentColor" stroke-width="2.5" fill="none" opacity="0.9" />
                            <path d="M32 44c-7.732-6.4-12-10.4-12-15.2C20 24.8 24.8 22 32 28c7.2-6 12-3.2 12 0.8 0 4.8-4.268 8.8-12 15.2z" fill="currentColor" fill-opacity="0.8"/>
                        </svg>
                    </div>
                    <h3 id="modal-name" class="text-xl font-bold text-white tracking-tight text-center mb-0.5"></h3>
                    <div class="text-sm text-white/55 truncate max-w-full px-2" id="modal-email"></div>
                    <div id="modal-status-badge" class="mt-3 px-3 py-1 rounded-full text-xs font-semibold tracking-wide"></div>
                </div>
                <div class="w-full px-6 pb-6 space-y-0">
                    <div class="rounded-2xl overflow-hidden border border-white/8" style="background: rgba(0,0,0,0.25);">
                        <div class="flex justify-between items-center py-3 px-4 border-b border-white/6">
                            <span class="text-white/50 text-sm font-medium">Joined</span>
                            <span id="modal-joined" class="text-white/90 text-sm font-medium"></span>
                        </div>
                        <div class="flex justify-between items-center py-3 px-4 border-b border-white/6">
                            <span class="text-white/50 text-sm font-medium">Last Login</span>
                            <span id="modal-last-login" class="text-white/90 text-sm font-medium"></span>
                        </div>
                        <div id="modal-location-row" class="hidden flex flex-col gap-2 py-3 px-4">
                            <div class="flex justify-between items-center">
                                <span class="text-white/50 text-sm font-medium flex items-center gap-1.5">
                                    <svg class="w-4 h-4 text-green-400/80" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                    Location
                                </span>
                                <a id="modal-location-link" href="#" target="_blank" rel="noopener noreferrer" class="text-green-400 hover:text-green-300 text-sm font-semibold transition-colors">View on map</a>
                            </div>
                            <div id="modal-location-place" class="text-white/80 text-sm"></div>
                            <div id="modal-location-updated" class="text-white/45 text-xs"></div>
                        </div>
                    </div>
                    <div class="w-full" style="margin-top: 1.5rem;"></div>
                    <button id="modal-delete-btn" class="w-full py-3 rounded-xl font-semibold text-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-400/40"
                            style="display:none; background: rgba(220,38,38,0.2); color: #f87171; border: 1px solid rgba(248,113,113,0.3);"
                            onmouseover="this.style.background='rgba(220,38,38,0.3)'" onmouseout="this.style.background='rgba(220,38,38,0.2)'">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Delete Connection
                    </button>
                </div>
            </div>
        </div>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('friend-modal');
            const closeModal = document.getElementById('close-modal');
            const nameEl = document.getElementById('modal-name');
            const emailEl = document.getElementById('modal-email');
            const joinedEl = document.getElementById('modal-joined');
            const lastLoginEl = document.getElementById('modal-last-login');
            const modalDeleteBtn = document.getElementById('modal-delete-btn');
            let currentEmail = null;
            var statusBadge = document.getElementById('modal-status-badge');
            document.querySelectorAll('.friend-item').forEach(function(item) {
                item.addEventListener('click', function(e) {
                    nameEl.textContent = item.getAttribute('data-name');
                    emailEl.textContent = item.getAttribute('data-email');
                    var status = item.getAttribute('data-status');
                    joinedEl.textContent = item.getAttribute('data-joined');
                    lastLoginEl.textContent = item.getAttribute('data-last-login');
                    currentEmail = item.getAttribute('data-email');
                    statusBadge.textContent = status;
                    statusBadge.className = 'mt-3 px-3 py-1 rounded-full text-xs font-semibold tracking-wide ';
                    if (status === 'Paused') statusBadge.className += 'bg-gray-500/20 text-gray-400';
                    else if (status === 'Active') statusBadge.className += 'bg-green-500/20 text-green-400';
                    else if (status === 'Warning') statusBadge.className += 'bg-yellow-500/20 text-yellow-400';
                    else statusBadge.className += 'bg-red-500/20 text-red-400';
                    var lat = item.getAttribute('data-lat');
                    var lng = item.getAttribute('data-lng');
                    var city = item.getAttribute('data-city');
                    var state = item.getAttribute('data-state');
                    var locationRow = document.getElementById('modal-location-row');
                    var locationLink = document.getElementById('modal-location-link');
                    var locationPlace = document.getElementById('modal-location-place');
                    var locationUpdated = document.getElementById('modal-location-updated');
                    if (lat && lng) {
                        locationRow.classList.remove('hidden');
                        locationLink.href = 'https://www.google.com/maps?q=' + encodeURIComponent(lat) + ',' + encodeURIComponent(lng);
                        var parts = [];
                        if (city) parts.push(city);
                        if (state) parts.push(state);
                        locationPlace.textContent = parts.length ? parts.join(', ') : '';
                        locationPlace.style.display = parts.length ? '' : 'none';
                        var updated = item.getAttribute('data-location-updated');
                        locationUpdated.textContent = updated ? updated : '';
                    } else {
                        locationRow.classList.add('hidden');
                    }
                    modalDeleteBtn.style.display = 'flex';
                    modal.classList.remove('hidden');
                });
            });
            closeModal.addEventListener('click', function() {
                modal.classList.add('hidden');
                modalDeleteBtn.style.display = 'none';
            });
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    modalDeleteBtn.style.display = 'none';
                }
            });
            modalDeleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (!currentEmail) return;
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const formData = new FormData();
                formData.append('delete_mapping', currentEmail);
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    showMessagePopup(data.success, data.message);
                    if (data.success) {
                        setTimeout(() => window.location.reload(), 1200);
                    }
                })
                .catch(error => {
                    showMessagePopup(false, 'Could not delete connection.');
                });
            });
        });
        </script>
        {% else %}
            <div class="w-full bg-black/30 border border-white/10 rounded-2xl px-6 py-8 flex flex-col items-center justify-center shadow-inner mt-2">
                <svg width="40" height="40" fill="none" viewBox="0 0 24 24" class="mb-2 opacity-60">
                    <circle cx="12" cy="12" r="10" stroke="white" stroke-width="1.5" fill="rgba(255,255,255,0.04)"/>
                    <path d="M8 15c0-1.657 2.686-3 6-3s6 1.343 6 3" stroke="white" stroke-width="1.2" stroke-linecap="round"/>
                    <circle cx="12" cy="9" r="3" stroke="white" stroke-width="1.2"/>
                </svg>
                <span class="text-gray-400/80 text-base font-medium">No members paired</span>
            </div>
        {% endif %}
    </div>
</div>
<script>
document.getElementById('invite-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        showMessagePopup(data.success, data.message);
        if (data.success) {
            // Reload the page after a short delay to show the updated paired users
            setTimeout(() => window.location.reload(), 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessagePopup(false, 'An error occurred. Please try again.');
    });
});
</script>
{% endblock %}
