{% extends 'core/base.html' %}
{% load static %}

{% block content %}
{% include 'core/app_icon.html' %}
<div class="w-full min-h-screen flex flex-col items-center" style="align-items: center; margin-top: 0; padding-top: 2vh;">
    <!-- Card 1: Invite Code Input -->
    <div class="w-full max-w-sm bg-black/30 backdrop-blur-2xl border border-white/10 rounded-3xl shadow-2xl p-4 flex flex-row items-center gap-2 animate-fade-in" style="margin-top: 4vh; border-top-left-radius: 0; border-top-right-radius: 0;">
        <form id="invite-form" class="flex flex-row w-full items-center gap-2">
            {% csrf_token %}
            <input name="invite_code" type="text" maxlength="5" placeholder="Enter invite code" class="flex-1 px-4 py-2 rounded-xl bg-black/40 border border-white/10 text-white text-center placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-400/40 transition-all duration-200" autocomplete="off" required />
            <button type="submit" class="ml-2 px-5 py-2 rounded-xl bg-gradient-to-r from-black/60 to-white/10 text-white font-semibold shadow hover:bg-white/10 border border-white/10 transition-all duration-200 whitespace-nowrap">Join</button>
        </form>
    </div>

    <!-- Stylish Heading -->
    <div class="w-full max-w-sm flex justify-center items-center mt-8">
        <h2 class="text-xl md:text-2xl font-bold tracking-wide text-white/90 bg-gradient-to-r from-green-400/80 via-blue-400/80 to-purple-400/80 bg-clip-text text-transparent drop-shadow-lg text-center w-full py-2 rounded-xl">
            Friends & Connections
        </h2>
    </div>
    <!-- Card 2: Paired Users List -->
    <div class="w-full max-w-sm bg-black/30 backdrop-blur-2xl border border-white/10 rounded-3xl shadow-2xl p-4 animate-fade-in mt-4" style="max-height: 270px; overflow-y: auto;">
        {% if paired_users %}
            <ul class="w-full flex flex-col gap-3">
                {% for friend in paired_users %}
                    {% with friend_profile=friend.profile %}
                    <li class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 flex items-center justify-between shadow-sm cursor-pointer friend-item group"
                        data-name="{{ friend.get_full_name|default:friend.email|default:'Unknown' }}"
                        data-email="{{ friend.email }}"
                        data-status="{% if friend_profile.is_missing %}Danger{% elif friend_profile.is_warning %}Warning{% else %}Active{% endif %}"
                        data-joined="{{ friend.date_joined|date:'d M Y, H:i' }}"
                        data-last-login="{{ friend.last_login|date:'d M Y, H:i' }}">
                        <span class="font-medium text-white/90 text-base">
                            {{ friend.get_full_name|default:friend.email|default:"Unknown" }}
                        </span>
                        {% if friend_profile.is_missing %}
                            <span class="text-xs px-2 py-1 rounded bg-red-500/20 text-red-400 font-semibold tracking-wide">Danger</span>
                        {% elif friend_profile.is_warning %}
                            <span class="text-xs px-2 py-1 rounded bg-yellow-400/20 text-yellow-300 font-semibold tracking-wide">Warning</span>
                        {% else %}
                            <span class="text-xs px-2 py-1 rounded bg-green-500/20 text-green-300 font-semibold tracking-wide">Active</span>
                        {% endif %}
                    </li>
                    {% endwith %}
                {% endfor %}
            </ul>
        </div>
        <!-- Friend Details Modal -->
        <div id="friend-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden" style="backdrop-filter: blur(8px); background: rgba(0,0,0,0.35);">
            <div class="relative bg-white/10 border border-white/20 rounded-2xl shadow-2xl p-8 max-w-xs w-full flex flex-col items-center glass-modal" style="backdrop-filter: blur(24px); box-shadow: 0 8px 32px 0 rgba(31,38,135,0.37);">
                <button id="close-modal" class="absolute top-3 right-3 text-white/80 hover:text-white text-2xl font-bold focus:outline-none">&times;</button>
                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-white/30 to-black/30 border border-white/20 flex items-center justify-center mb-4">
                    <svg width="36" height="36" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="32" cy="32" r="23" stroke="#fff" stroke-width="3" fill="none" />
                        <circle cx="32" cy="32" r="29" stroke="#fff" stroke-width="1.2" fill="none" opacity="0.08" />
                        <path d="M32 44c-7.732-6.4-12-10.4-12-15.2C20 24.8 24.8 22 32 28c7.2-6 12-3.2 12 0.8 0 4.8-4.268 8.8-12 15.2z" fill="#fff" fill-opacity="0.7"/>
                    </svg>
                </div>
                <h3 id="modal-name" class="text-lg font-bold text-white/90 mb-1 text-center"></h3>
                <div class="text-sm text-white/70 mb-2" id="modal-email"></div>
                <div class="flex flex-col gap-1 w-full mt-2">
                    <div class="flex justify-between text-white/80"><span>Status:</span><span id="modal-status" class="font-semibold"></span></div>
                    <div class="flex justify-between text-white/80"><span>Joined:</span><span id="modal-joined"></span></div>
                    <div class="flex justify-between text-white/80"><span>Last Login:</span><span id="modal-last-login"></span></div>
                </div>
                <button id="modal-delete-btn" class="mt-6 px-5 py-2 rounded-xl bg-gradient-to-r from-red-600/80 to-red-400/60 text-white font-semibold shadow hover:bg-red-700/80 border border-red-400/30 transition-all duration-200 flex items-center gap-2" style="display:none;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 7h12M9 7V4a1 1 0 011-1h4a1 1 0 011 1v3m-7 0h10M5 7h14M6 7v10a2 2 0 002 2h8a2 2 0 002-2V7" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11v6m4-6v6" />
                    </svg>
                    Delete Connection
                </button>
            </div>
        </div>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('friend-modal');
            const closeModal = document.getElementById('close-modal');
            const nameEl = document.getElementById('modal-name');
            const emailEl = document.getElementById('modal-email');
            const statusEl = document.getElementById('modal-status');
            const joinedEl = document.getElementById('modal-joined');
            const lastLoginEl = document.getElementById('modal-last-login');
            const modalDeleteBtn = document.getElementById('modal-delete-btn');
            let currentEmail = null;
            document.querySelectorAll('.friend-item').forEach(function(item) {
                item.addEventListener('click', function(e) {
                    nameEl.textContent = item.getAttribute('data-name');
                    emailEl.textContent = item.getAttribute('data-email');
                    statusEl.textContent = item.getAttribute('data-status');
                    joinedEl.textContent = item.getAttribute('data-joined');
                    lastLoginEl.textContent = item.getAttribute('data-last-login');
                    currentEmail = item.getAttribute('data-email');
                    modalDeleteBtn.style.display = 'flex';
                    modal.classList.remove('hidden');
                });
            });
            closeModal.addEventListener('click', function() {
                modal.classList.add('hidden');
                modalDeleteBtn.style.display = 'none';
            });
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    modalDeleteBtn.style.display = 'none';
                }
            });
            modalDeleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (!currentEmail) return;
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const formData = new FormData();
                formData.append('delete_mapping', currentEmail);
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    showMessagePopup(data.success, data.message);
                    if (data.success) {
                        setTimeout(() => window.location.reload(), 1200);
                    }
                })
                .catch(error => {
                    showMessagePopup(false, 'Could not delete connection.');
                });
            });
        });
        </script>
        {% else %}
            <div class="w-full bg-black/30 border border-white/10 rounded-2xl px-6 py-8 flex flex-col items-center justify-center shadow-inner mt-2">
                <svg width="40" height="40" fill="none" viewBox="0 0 24 24" class="mb-2 opacity-60">
                    <circle cx="12" cy="12" r="10" stroke="white" stroke-width="1.5" fill="rgba(255,255,255,0.04)"/>
                    <path d="M8 15c0-1.657 2.686-3 6-3s6 1.343 6 3" stroke="white" stroke-width="1.2" stroke-linecap="round"/>
                    <circle cx="12" cy="9" r="3" stroke="white" stroke-width="1.2"/>
                </svg>
                <span class="text-gray-400/80 text-base font-medium">No members paired</span>
            </div>
        {% endif %}
    </div>
</div>
<script>
document.getElementById('invite-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        showMessagePopup(data.success, data.message);
        if (data.success) {
            // Reload the page after a short delay to show the updated paired users
            setTimeout(() => window.location.reload(), 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessagePopup(false, 'An error occurred. Please try again.');
    });
});
</script>
{% endblock %}
